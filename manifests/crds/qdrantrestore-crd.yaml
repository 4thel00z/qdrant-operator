apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: qdrantrestores.qdrant.io
spec:
  group: qdrant.io
  names:
    kind: QdrantRestore
    listKind: QdrantRestoreList
    plural: qdrantrestores
    singular: qdrantrestore
    shortNames:
      - qr
  scope: Namespaced
  versions:
    - name: v1alpha1
      served: true
      storage: true
      subresources:
        status: {}
      additionalPrinterColumns:
        - name: Source
          type: string
          jsonPath: .spec.backupRef.name
        - name: Target
          type: string
          jsonPath: .spec.targetClusterRef.name
        - name: Phase
          type: string
          jsonPath: .status.phase
        - name: Age
          type: date
          jsonPath: .metadata.creationTimestamp
      schema:
        openAPIV3Schema:
          type: object
          required:
            - spec
          properties:
            spec:
              type: object
              required:
                - targetClusterRef
              properties:
                backupRef:
                  type: object
                  description: Reference to a QdrantBackup resource
                  properties:
                    name:
                      type: string
                    namespace:
                      type: string
                source:
                  type: object
                  description: Direct S3 source (alternative to backupRef)
                  properties:
                    s3:
                      type: object
                      required:
                        - bucket
                        - path
                        - credentialsSecretRef
                      properties:
                        bucket:
                          type: string
                        path:
                          type: string
                          description: Path within the bucket to the backup
                        region:
                          type: string
                          default: "us-east-1"
                        endpoint:
                          type: string
                        forcePathStyle:
                          type: boolean
                          default: false
                        credentialsSecretRef:
                          type: object
                          required:
                            - name
                          properties:
                            name:
                              type: string
                            accessKeyIdKey:
                              type: string
                              default: "AWS_ACCESS_KEY_ID"
                            secretAccessKeyKey:
                              type: string
                              default: "AWS_SECRET_ACCESS_KEY"
                targetClusterRef:
                  type: object
                  required:
                    - name
                  properties:
                    name:
                      type: string
                    namespace:
                      type: string
                collections:
                  type: array
                  items:
                    type: string
                  description: List of collections to restore (empty = all from backup)
                collectionMapping:
                  type: object
                  additionalProperties:
                    type: string
                  description: Rename collections during restore (source -> target)
                priority:
                  type: string
                  enum: ["snapshot", "replica"]
                  default: "snapshot"
                  description: Recovery priority mode
                waitForIndexing:
                  type: boolean
                  default: true
                  description: Wait for HNSW index to be built after restore
            status:
              type: object
              properties:
                phase:
                  type: string
                  enum: ["Pending", "Downloading", "Restoring", "Indexing", "Completed", "Failed"]
                startTime:
                  type: string
                  format: date-time
                completionTime:
                  type: string
                  format: date-time
                sourceBackup:
                  type: string
                  description: Resolved backup name or S3 path
                restoredCollections:
                  type: array
                  items:
                    type: object
                    properties:
                      name:
                        type: string
                      originalName:
                        type: string
                        description: Original name if remapped
                      status:
                        type: string
                        enum: ["Pending", "Downloading", "Restoring", "Indexing", "Completed", "Failed"]
                      size:
                        type: string
                      pointsCount:
                        type: integer
                      error:
                        type: string
                progress:
                  type: object
                  properties:
                    collectionsTotal:
                      type: integer
                    collectionsCompleted:
                      type: integer
                    currentCollection:
                      type: string
                    percentage:
                      type: integer
                      minimum: 0
                      maximum: 100
                error:
                  type: string
                conditions:
                  type: array
                  items:
                    type: object
                    required:
                      - type
                      - status
                    properties:
                      type:
                        type: string
                      status:
                        type: string
                        enum: ["True", "False", "Unknown"]
                      lastTransitionTime:
                        type: string
                        format: date-time
                      reason:
                        type: string
                      message:
                        type: string